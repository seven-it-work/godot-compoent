# 服务器端战斗逻辑实现计划

## 1. 核心目标

实现 `src/server/controller/BattleController.ts` 中的 `performBattle` 方法，记录战斗日志并返回战斗结果。

## 2. 实现步骤

### 2.1 修改 Player 类，添加战斗日志数组

* 在 `Player.ts` 中添加 `battleLogs: string[]` 属性，用于记录战斗日志

* 添加 `addBattleLog(log: string)` 方法，用于向日志数组中添加日志

### 2.2 实现 BattleController.performBattle 方法

* 初始化战斗状态

* 确定先手方

* 循环执行攻击，直到战斗结束

* 记录详细的战斗日志

* 返回战斗结果

### 2.3 实现战斗核心逻辑

#### 2.3.1 战斗初始化

* 重置战斗状态

* 复制战场随从到战斗随从数组

* 初始化战斗日志

#### 2.3.2 先手方判断

* 随从数量多的为先手

* 随从数量相同，随机先手

#### 2.3.3 攻击循环

* 轮流进行攻击，直到战斗结束

* 每轮攻击包括：

  * 获取攻击随从

  * 获取攻击目标

  * 执行攻击

  * 处理伤害

  * 处理死亡

  * 处理亡语

#### 2.3.4 攻击目标选择

* 优先攻击有嘲讽的随从，多个嘲讽随从，随机选择一个嘲讽随从

* 禁止攻击潜行的随从

* 没有嘲讽随从时，随机选择目标

#### 2.3.5 伤害处理

* 处理圣盾效果

* 计算伤害

* 更新随从生命值

* 记录伤害日志

#### 2.3.6 死亡处理

* 移除死亡随从

* 处理复生效果

* 记录死亡日志

#### 2.3.7 亡语处理

* 执行随从的亡语效果

* 记录亡语日志

#### 2.3.8 战斗结束判断

* 一方没有随从

* 双方攻击力总和都为0

### 2.4 实现战斗结果计算

* 统计剩余随从数量

* 计算战斗结果（胜利、失败、平局）

* 记录战斗结束日志

## 3. 日志记录要求

### 3.1 日志类型

* 战斗开始日志

* 先手方日志

* 攻击日志

* 伤害日志

* 死亡日志

* 亡语日志

* 战斗结束日志

### 3.2 日志格式示例

* `战斗开始：玩家[玩家名] vs 敌方[敌方名]`

* `先手方：玩家[玩家名]`

* `玩家[玩家名]的随从[随从名]攻击了敌方[敌方名]的随从[随从名]`

* `玩家[玩家名]的随从[随从名]受到了[伤害值]点伤害，剩余生命值：[剩余生命值]`

* `玩家[玩家名]的随从[随从名]的圣盾被打破了！`

* `玩家[玩家名]的随从[随从名]被杀死了！`

* `玩家[玩家名]的随从[随从名]触发了亡语效果！`

* `战斗结束：玩家[玩家名]胜利，剩余随从：[剩余数量]`

## 4. 代码实现规范

### 4.1 类型安全

* 使用 TypeScript 类型系统确保代码安全

* 避免使用 `any` 类型

### 4.2 模块化设计

* 将战斗逻辑分解为多个辅助方法

* 提高代码的可读性和可维护性

### 4.3 日志清晰

* 确保日志信息完整、清晰

* 包含足够的上下文信息

### 4.4 性能优化

* 避免不必要的计算和内存分配

* 优化循环和条件判断

## 5. 测试要求

* 确保战斗逻辑正确执行

* 确保日志记录完整

* 确保战斗结果计算正确

* 确保没有类型错误

## 6. 预期输出

* 完整的战斗日志数组

* 战斗结果（胜利、失败、平局）

* 剩余随从数量

## 7. 依赖关系

* `src/server/controller/entity/Player.ts`

* `src/server/controller/entity/Minion.ts`

* `src/server/controller/entity/Card.ts`

* `src/server/controller/entity/Result.ts`


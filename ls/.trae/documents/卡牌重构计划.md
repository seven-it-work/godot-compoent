# 卡牌重构计划

## 1. 目标

将 `d:\godot-compoent\ls\src\game\cards` 中的卡牌重构到 `d:\godot-compoent\ls\src\server\all_cards` 目录中，确保卡牌在新环境中能正常工作。

## 2. 目录结构映射

| 源目录                                | 目标目录                                      |
| ---------------------------------- | ----------------------------------------- |
| `src/game/cards/minion/beast/`     | `src/server/all_cards/minions/beast/`     |
| `src/game/cards/minion/demon/`     | `src/server/all_cards/minions/demon/`     |
| `src/game/cards/minion/dragon/`    | `src/server/all_cards/minions/dragon/`    |
| `src/game/cards/minion/elemental/` | `src/server/all_cards/minions/elemental/` |
| `src/game/cards/minion/mech/`      | `src/server/all_cards/minions/mech/`      |
| `src/game/cards/minion/murloc/`    | `src/server/all_cards/minions/murloc/`    |
| `src/game/cards/minion/naga/`      | `src/server/all_cards/minions/naga/`      |
| `src/game/cards/minion/pirate/`    | `src/server/all_cards/minions/pirate/`    |
| `src/game/cards/minion/quilboar/`  | `src/server/all_cards/minions/quilboar/`  |
| `src/game/cards/minion/undead/`    | `src/server/all_cards/minions/undead/`    |
| `src/game/cards/spell/`            | `src/server/all_cards/spell/`             |

## 3. 关键差异分析

| 差异点            | 源目录（game/cards）              | 目标目录（server/all\_cards）                                                    |
| -------------- | ---------------------------- | -------------------------------------------------------------------------- |
| **导入路径**       | `@/game/Minion`              | `@/server/controller/entity/Minion`                                        |
| **BASE\_DATA** | `static BASE_DATA = { ... }` | `const BASE_DATA = { ... }`（文件末尾）                                          |
| **构造函数**       | 无显式构造函数                      | `constructor() { super(); minion_utils.initMinionData(this, BASE_DATA); }` |
| **inTavern属性** | 无                            | `inTavern: boolean = true;`                                                |
| **方法参数**       | `battlecry(game: any)`       | `battlecry(player: Player)`                                                |
| **工具函数**       | `getMinionClassByStrId()`    | `db_card.getCardByStrId()`                                                 |

## 4. 重构步骤

### 4.1 准备工作

1. 确保目标目录结构完整
2. 分析源目录中的所有卡牌文件
3. 创建卡牌类名和strId的映射表

### 4.2 单卡牌重构流程

对于每个卡牌文件：

1. **复制文件**到对应的目标目录
2. **更新导入语句**：

   * 将 `@/game/Minion` 替换为 `@/server/controller/entity/Minion`

   * 添加 `minion_utils` 导入

   * 替换其他相关导入
3. **添加类属性**：

   ```typescript
   inTavern: boolean = true;
   ```
4. **添加构造函数**：

   ```typescript
   constructor() {
     super();
     minion_utils.initMinionData(this, BASE_DATA);
   }
   ```
5. **转换BASE\_DATA**：

   * 将 `static BASE_DATA = { ... }` 移动到文件末尾

   * 改为 `const BASE_DATA = { ... }`
6. **更新方法签名**：

   * 将 `game: any` 替换为 `player: Player`

   * 更新方法实现以匹配新的参数类型
7. **更新工具函数调用**：

   * 将 `getMinionClassByStrId()` 替换为 `db_card.getCardByStrId()`

   * 调整实例创建逻辑
8. **修复其他类型错误**

### 4.3 示例重构（Alleycat.ts）

**源文件**：

```typescript
import { Minion } from '@/game/Minion';
import { getMinionClassByStrId } from '@/game/cards/minion/MinionClassMap';

export class Alleycat extends Minion {
  static BASE_DATA = { /* ... */ };
  
  battlecry(game: any): void {
    // 战吼逻辑
  }
}
```

**重构后**：

```typescript
import { Minion, minion_utils } from '@/server/controller/entity/Minion';
import type { Player } from '@/server/controller/entity/Player';
import db_card from '@/server/db/db_card';

export class Alleycat extends Minion {
  inTavern: boolean = true;
  
  constructor() {
    super();
    minion_utils.initMinionData(this, BASE_DATA);
  }
  
  battlecry(player: Player): void {
    // 更新后的战吼逻辑
  }
}

const BASE_DATA = { /* ... */ };
```

## 5. 测试计划

1. **编译测试**：运行 `npx vue-tsc -b` 检查类型错误
2. **运行时测试**：确保重构后的卡牌能正常初始化和触发效果
3. **功能测试**：验证卡牌的特殊效果（战吼、亡语等）能正常执行

## 6. 风险评估

1. **类型不兼容**：目标目录使用不同的类型定义，可能需要大量类型调整
2. **方法签名差异**：卡牌效果方法的参数类型和返回值不同
3. **工具函数差异**：获取卡牌类和创建实例的方式不同
4. **依赖关系**：可能存在未发现的依赖关系，导致重构后卡牌无法正常工作

## 7. 预期成果

1. 所有卡牌从 `game/cards` 目录成功迁移到 `server/all_cards` 目录
2. 迁移后的卡牌能通过类型检查
3. 卡牌的特殊效果能正常触发
4. 保持卡牌的原有功能不变

## 8. 后续工作

1. 更新卡牌数据库引用
2. 移除源目录中的旧卡牌文件
3. 更新相关文档
4. 进行全面的游戏测试

## 9. 执行顺序

1. 先重构少量卡牌进行测试
2. 验证测试通过后，批量重构剩余卡牌
3. 最后进行全面测试和清理工作


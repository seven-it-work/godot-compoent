## 问题分析

当只有玩家在队伍中，战斗时玩家生命值=0了，没有立马结束战斗，而是等待了好几次才结束。

### 根本原因
1. **战斗结束判定时机不当**：战斗结束条件只在攻击后和行动进度更新前检查，存在延迟
2. **行动队列未实时更新**：角色死亡后仍留在行动队列中继续积累进度
3. **战斗循环未立即停止**：即使满足结束条件，也需要等待下一次循环检查

### 修复方案

#### 1. 优化 `updateActionProgress` 函数
- 在每次更新行动进度**后**立即检查战斗结束条件
- 确保一旦所有玩家或敌人死亡，立即调用 `handleEndBattle` 函数

#### 2. 修复 `performAttack` 函数
- 确保攻击后正确检查战斗结束条件
- 统一战斗结束判定逻辑

#### 3. 优化战斗结束判定逻辑
- 确保 `allPlayersDead` 和 `allEnemiesDead` 计算准确
- 当满足结束条件时立即停止战斗循环

### 具体修改点

1. **修改 `updateActionProgress` 函数**（第568-624行）：
   - 将战斗结束检查移到进度更新后
   - 确保一旦满足条件立即结束战斗

2. **优化 `performAttack` 函数**（第515-565行）：
   - 简化战斗结束检查逻辑
   - 确保与 `updateActionProgress` 中的检查逻辑一致

3. **增强 `handleEndBattle` 函数**（第642-663行）：
   - 确保战斗结束后立即停止战斗循环
   - 清理相关状态

### 预期效果
- 当玩家生命值降为0时，战斗立即结束
- 当所有敌人死亡时，战斗立即结束
- 消除战斗结束前的延迟等待
- 提升战斗体验的流畅性和合理性